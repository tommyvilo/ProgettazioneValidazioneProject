<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title th:text="'HomePage - ' + ${username}">HomePage - Researcher</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="/researcher.css">
</head>

<body>
<div class="welcome-container">
    <h1 id="welcomeTitle" >Welcome RESEARCHER <span id="username" th:text="${username}">username</span></h1>
    <a id="logout" href="/logout" class="logout-button">Logout</a>
</div>

<!-- Selezione data -->
<div style="text-align: center; margin: 20px;">
    <label for="sceltaData">Seleziona una data:</label>
    <input type="date" id="sceltaData" name="selectedDate" th:value="${selectedDate}" onchange="updateDate(this)">
</div>

<form action="saveWorkingTime">
    <div class="table-container" id="projectTableContainer">
        <h1>PROJECT LIST</h1>
        <table>
            <thead>
            <tr>
                <th>TITLE</th>
                <th>CUP</th>
                <th>FUNDING AGENCY</th>
                <th>DAILY WORKING HOURS</th>
                <th></th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="hour: ${hours}">
                <td id="projectTitle" th:text="${hour.getProject().title}">Project Title</td>
                <td th:text="${hour.getProject().cup}">CUP</td>
                <td th:text="${hour.getProject().denominazioneSoggetto}">Funding Agency</td>
                <td>
                    <input type="range" id="hours" name="hours" min="0" max="8" step="0.25"
                           th:value="${hour.workedHours}" oninput="updateHours(this)">
                    <output th:text="${hour.getFormattedHours()}">1:00</output>
                </td>
                <td id="timesheetColumn"><a id="downloadTimesheet" th:href="@{downloadTimesheet(id=${hour.getProject().id})}">Download Timesheet</a></td>
            </tr>
            </tbody>
        </table>

        <!-- Pulsante per salvare le ore lavorative -->

    </div>

    <!-- Checkbox per ferie sotto la tabella -->
    <div style="text-align: center; margin: 20px;">
        <label>
            <input type="checkbox" name="checkbox" id="vacationCheckbox" th:checked="${status}" onchange="toggleVacationMode()"> Segna come giornata di ferie
        </label>
    </div>

    <button class="save-button" id="saveButton" disabled>Salva ore lavorative</button>

</form>

<script th:inline="javascript">
    let initialSliderValues = [];
    let vacationMode = false;
    let festivita = [[${isHoliday}]];

    window.onload = function() {
        const sliders = document.querySelectorAll('input[type="range"][name="hours"]');
        sliders.forEach(slider => {
            initialSliderValues.push(parseFloat(slider.value));
        });

        if (festivita) {
            blockAllDueToHoliday();
        } else {
            checkTotalHours();
        }

        // Imposta il valore iniziale del datePicker
        const datePicker = document.getElementById('sceltaData');
        datePicker.value = [[${selectedDate}]];
    };

    function updateDate(dateInput) {
        const selectedDate = dateInput.value; // Ottieni la data selezionata
        if (selectedDate) {
            // Reindirizza alla pagina researcher.html con il parametro della data
            window.location.href = `/researcher.html?date=${selectedDate}`;
        }
    }

    function blockAllDueToHoliday() {
        const sliders = document.querySelectorAll('input[type="range"][name="hours"]');
        sliders.forEach(slider => {
            slider.disabled = true;
        });

        const saveButton = document.getElementById('saveButton');
        saveButton.style.display = 'none';

        const vacationCheckbox = document.getElementById('vacationCheckbox');
        vacationCheckbox.disabled = true;

        alert('Oggi non Ã¨ un giorno lavorativo. Le modifiche non sono consentite.');
    }

    function updateHours(slider) {
        const value = parseFloat(slider.value);
        const hours = Math.floor(value);
        const minutes = Math.round((value - hours) * 60);
        slider.nextElementSibling.value = `${hours}:${minutes.toString().padStart(2, '0')}`;
        checkTotalHours();
    }

    function checkTotalHours() {
        const sliders = document.querySelectorAll('input[type="range"][name="hours"]');
        const saveButton = document.getElementById('saveButton');
        let totalHours = 0;
        let hasChanges = false;

        sliders.forEach((slider, index) => {
            const currentValue = parseFloat(slider.value);
            totalHours += currentValue;

            if (currentValue !== initialSliderValues[index]) {
                hasChanges = true;
            }
        });

        if (totalHours > 8) {
            saveButton.classList.add('disabled');
            saveButton.textContent = 'Errore: Ore lavorative totali giornaliere superate';
            saveButton.disabled = true;
            saveButton.style.display = 'block';
        } else if (hasChanges && !vacationMode) {
            saveButton.classList.remove('disabled');
            saveButton.textContent = 'Salva ore lavorative';
            saveButton.disabled = false;
            saveButton.style.display = 'block';
        } else {
            saveButton.style.display = 'none';
        }
    }

    function toggleVacationMode() {
        vacationMode = Boolean(document.getElementById('vacationCheckbox').checked);

        const sliders = document.querySelectorAll('input[type="range"][name="hours"]');
        const saveButton = document.getElementById('saveButton');

        if (vacationMode) {
            if (status !== vacationMode) {
                saveButton.classList.remove('disabled');
                saveButton.textContent = 'Salva ore lavorative';
                saveButton.disabled = false;
                saveButton.style.display = 'block';
            } else {
                saveButton.style.display = 'none';
            }

            sliders.forEach(slider => {
                slider.disabled = true;
            });

        } else {
            sliders.forEach(slider => {
                slider.disabled = false;
            });

            checkTotalHours();
        }
    }


    let status = Boolean(vacationMode = document.getElementById('vacationCheckbox').checked);
    toggleVacationMode();
</script>

</body>
</html>